#!/usr/bin/env bash
set -euo pipefail

PROJECT=${PROJECT:-${WORKSPACE}}
CONTEXT=${CONTEXT:-${PROJECT}}
VERBOSE=${VERBOSE:-0}

echo "➜  \`step\` - committing modifications within: '${CONTEXT}'"
echo "➜  ..."

git add ${CONTEXT}

if [[ "$@" == "" ]] ; then
  journal=$(
    git diff --staged -- doc/JOURNAL.md \
    | grep -e '^\+' \
    | grep -v '+++' \
    | sed 's/^\+/ /g'
  )

  message="step ➜

$journal
"

  if [[ "$VERBOSE" != "0" ]] ; then
    echo "➜  with journal:"
    echo "$message"
  fi

  git duet-commit -m "$message"
else
  git duet-commit "$@"
fi
